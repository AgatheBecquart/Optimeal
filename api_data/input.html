<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>README - Script d'extraction des données</title>
</head>
<body>
    <h1>README - Script d'extraction des données</h1>

    <h2>Description</h2>
    <p>
        Ce dossier contient les scripts nécessaires pour l'extraction, le traitement et l'insertion des données dans une base de données SQL Server pour le projet de prévision des couverts de la cantine de la Banque Populaire du Nord.
    </p>

    <h2>Fichiers principaux</h2>
    <ul>
        <li><strong>create_table.py</strong> : Script principal pour la création des tables et l'insertion des données.</li>
        <li><strong>drop_table.py</strong> : Script pour supprimer les tables existantes.</li>
        <li><strong>models.py</strong> : Définition des modèles de données utilisés dans le projet.</li>
    </ul>

    <h2>Dépendances</h2>
    <p>Le script utilise plusieurs bibliothèques Python. Assurez-vous d'avoir installé :</p>
    <ul>
        <li>pyodbc</li>
        <li>python-dotenv</li>
        <li>requests</li>
        <li>pytz</li>
    </ul>
    <p>Vous pouvez les installer avec pip :</p>
    <pre><code>pip install pyodbc python-dotenv requests pytz</code></pre>

    <h2>Configuration</h2>
    <p>Créez un fichier <strong>.env</strong> à la racine du projet avec les variables suivantes :</p>
    <ul>
        <li>SERVER : l'adresse du serveur SQL</li>
        <li>DATABASE : le nom de la base de données</li>
        <li>AZUREUSER : le nom d'utilisateur pour la connexion à la base de données</li>
        <li>PASSWORD : le mot de passe pour la connexion à la base de données</li>
        <li>API_KEY : la clé API pour le service météorologique</li>
    </ul>
    <p>Assurez-vous d'avoir le pilote ODBC 17 pour SQL Server installé sur votre système.</p>

    <h2>Fonctionnalités principales</h2>

    <h3>Création des tables</h3>
    <p>Le script crée trois tables principales :</p>
    <ul>
        <li><strong>Meteo</strong> : Stocke les données météorologiques.</li>
        <li><strong>RepasVendus</strong> : Enregistre le nombre de couverts vendus par jour.</li>
        <li><strong>PresenceRH</strong> : Contient les données de présence des employés.</li>
    </ul>
    <p>La structure de ces tables est définie dans <strong>models.py</strong></p>

    <h3>Extraction et insertion des données météorologiques</h3>
    <p>
        Les données météorologiques sont récupérées via l'API OpenWeatherMap. La fonction <strong>get_weather_data_for_period</strong> effectue les requêtes API pour une période donnée. Les données sont ensuite insérées dans la table Meteo à l'aide de la fonction <strong>insert_weather_data</strong>.
    </p>

    <h3>Importation des données de repas vendus par CSV</h3>
    <p>
        Les données de repas vendus sont importées à partir de fichiers CSV. La fonction <strong>insert_csv_data</strong> gère l'insertion de ces données dans les tables respectives.
    </p>
    <h3>Extraction des données RH</h3>
    <p>
        Les données RH sont extraites du SI de la Banque Populaire du Nord à l'aide d'une requête SQL complexe avant d'être enregistrées dans un fichier CSV. Ce fichier est ensuite chargé dans les tables de la base de données.
    </p>
    <p>
        La requête SQL utilise les filtres suivants :
    </p>
    <ul>
        <li>Utilisation de jointures LEFT JOIN pour lier les différentes tables de données RH.</li>
        <li>Filtrage des jours de travail en excluant les week-ends (NUMJS NOT IN ('6', '7')).</li>
        <li>Sélection uniquement des présences physiques (TYPE_PRESENCE = 'P').</li>
        <li>Exclusion de certains motifs de présence comme le télétravail et les déplacements.</li>
        <li>Filtrage des structures organisationnelles spécifiques.</li>
    </ul>
    <p>
        Cette requête permet d'obtenir des données précises sur la présence des employés, essentielles pour la prévision des couverts de la cantine.
    </p>
    <p>Pour la table PresenceRH, les identifiants des agents sont anonymisés avant l'insertion.</p>

    <h3>Anonymisation des données</h3>
    <p>
        Pour respecter le RGPD, les identifiants des agents sont anonymisés avant l'insertion dans la base de données :
    </p>

    <h2>Utilisation</h2>
    <p>Pour créer les tables et insérer les données :</p>
    <pre><code>python create_table.py</code></pre>
    <p>Pour supprimer les tables existantes :</p>
    <pre><code>python drop_table.py</code></pre>

    <h2>Gestion des erreurs</h2>
    <p>
        Le script inclut une gestion des erreurs pour chaque étape du processus, avec des messages d'erreur détaillés en cas de problème lors de l'insertion ou de la récupération des données.
    </p>

    <h2>Modèles de données</h2>
    <p>
        Les modèles de données sont définis dans <strong>models.py</strong> pour assurer la cohérence et la validation des données :
    </p>

    <h2>Remarques importantes</h2>
    <ul>
        <li>Assurez-vous que les fichiers CSV sont placés dans le dossier <strong>data/</strong> avant l'exécution du script.</li>
        <li>Le script est configuré pour récupérer les données météorologiques de Marcq-en-Baroeul (coordonnées : lat = 50.6788, lon = 3.0915).</li>
        <li>La période de récupération des données météorologiques est actuellement fixée du <strong>01/09/2023 au 28/09/2024</strong>. Modifiez ces dates si nécessaire.</li>
    </ul>

    <h2>Sécurité</h2>
    <ul>
        <li>Les informations sensibles (identifiants de connexion, clés API) sont stockées dans le fichier <strong>.env</strong> et ne doivent pas être partagées ou versionnées.</li>
        <li>Les identifiants des agents sont anonymisés pour respecter le RGPD.</li>
    </ul>

</body>
</html>
